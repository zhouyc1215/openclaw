# 飞书实时调用分析

## 最新调用记录

### 调用 #1 (11:34:20 - 11:34:24)

**时间线**：
```
11:34:20.435 - 📨 飞书收到消息
11:34:20.443 - 🚀 分发到 Agent
11:34:21.121 - ⌨️  添加"正在输入"指示器
11:34:21.142 - ⚙️  Agent 开始运行
              Provider: qwen-portal
              Model: qwen-plus
11:34:21.153 - 💭 Prompt 处理开始
11:34:21.154 - 🔄 Agent 执行中
11:34:23.472 - 📤 准备发送回复
              内容: {"name": "exec", "arguments": {"command": "date '+%Y-%m-%d %H:%M:%S %Z'"}}
11:34:23.478 - 📨 发送 1 个文本块
11:34:23.485 - ✅ Agent 执行完成
11:34:23.488 - ⏱️  Prompt 处理完成 (2335ms)
11:34:23.495 - ✅ Agent 运行完成 (2369ms)
11:34:24.050 - ✉️  消息发送完成
              queuedFinal=false, replies=0
```

**问题分析**：
1. ❌ **返回了工具调用而不是文本**：`{"name": "exec", "arguments": {...}}`
2. ❌ **queuedFinal=false, replies=0**：表示没有最终回复
3. ✅ API 调用成功（没有 HTTP 400 错误）
4. ✅ Agent 执行速度正常（2.3 秒）

---

### 调用 #2 (11:34:39)

**时间线**：
```
11:34:39.918 - 📨 飞书收到消息
11:34:39.920 - 🚀 分发到 Agent
11:34:39.921 - ✉️  消息发送完成（立即）
              queuedFinal=false, replies=0
```

**问题分析**：
1. ❌ **Agent 没有启动**：消息收到后立即完成，没有执行
2. ❌ **queuedFinal=false, replies=0**：没有回复
3. ⚠️  可能是重复消息或系统消息被过滤

---

## 核心问题

### 问题 1：Agent 返回工具调用而不是文本

**现象**：
- Agent 正常执行
- API 调用成功（账户已充值）
- 但返回的是工具调用 JSON：`{"name": "exec", "arguments": {...}}`
- 这个 JSON 被直接发送到飞书

**原因分析**：

1. **模型行为异常**：
   - 通义千问模型可能误解了用户消息
   - 认为需要调用 `exec` 工具来执行命令
   - 而不是直接回复文本

2. **系统提示词问题**：
   - Agent 的系统提示词可能包含了工具定义
   - 模型"看到"了工具列表，倾向于调用工具

3. **用户消息内容**：
   - 用户可能发送了类似"现在几点"或"查看时间"的消息
   - 模型认为需要调用 `exec` 工具执行 `date` 命令

### 问题 2：工具调用未被执行

**现象**：
- Agent 返回了工具调用
- 但工具没有被执行
- 工具调用的 JSON 直接发送给用户

**原因分析**：

1. **工具执行流程缺失**：
   - Clawdbot 应该检测到工具调用
   - 执行工具
   - 将结果返回给模型
   - 模型生成最终回复

2. **当前行为**：
   - Agent 返回工具调用后就结束了
   - 没有进入工具执行循环
   - `queuedFinal=false` 表示这不是最终回复
   - 但没有后续处理

---

## 解决方案

### 方案 1：检查用户消息内容

查看用户到底发送了什么消息：

```bash
grep -A 10 "11:34:20" /tmp/clawdbot/clawdbot-*.log | grep -i "content\|text\|message"
```

### 方案 2：检查 Agent 配置

查看 Agent 是否启用了工具：

```bash
pnpm clawdbot config get agents.defaults
```

### 方案 3：禁用工具（临时）

如果不需要工具功能，可以临时禁用：

```json
{
  "agents": {
    "defaults": {
      "tools": {
        "enabled": false
      }
    }
  }
}
```

### 方案 4：修改系统提示词

确保系统提示词不会误导模型调用工具。

---

## 测试建议

### 测试 1：发送简单消息

在飞书发送：
```
你好
```

预期：应该返回文本回复，而不是工具调用

### 测试 2：发送明确的问题

在飞书发送：
```
请用一句话介绍你自己
```

预期：应该返回文本回复

### 测试 3：发送可能触发工具的消息

在飞书发送：
```
现在几点？
```

观察：是否会触发工具调用

---

## 监控命令

实时监控正在运行，可以看到：
- 消息接收
- Agent 执行
- 工具调用
- 回复发送

继续在飞书发送消息，我会实时看到处理流程。
