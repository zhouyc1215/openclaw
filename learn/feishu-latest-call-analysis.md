# 飞书最新调用分析

## 时间线分析

### 第一次调用（11:22:41 - 11:22:43）- 失败
```
11:22:41.830 - 飞书收到消息
11:22:41.851 - 分发到 Agent
11:22:42.268 - 添加"正在输入"指示器
11:22:42.297 - Agent 开始运行（qwen-portal/qwen-plus）
11:22:42.330 - Prompt 开始
11:22:42.333 - Agent 开始
11:22:42.689 - Agent 结束
11:22:42.695 - Prompt 结束（耗时 365ms）
11:22:42.705 - Agent 运行完成（总耗时 426ms）
11:22:42.718 - 返回错误消息：HTTP 400: Access denied
11:22:43.427 - 消息发送完成
```

**问题**：阿里云账户欠费，API 调用失败

---

### 第二次调用（11:29:14 - 11:29:17）- 异常

```
11:29:14.411 - 飞书收到消息
11:29:14.412 - 分发到 Agent
11:29:14.820 - 添加"正在输入"指示器
11:29:14.843 - Agent 开始运行（qwen-portal/qwen-plus）
11:29:14.854 - Prompt 开始
11:29:14.856 - Agent 开始
11:29:16.806 - 返回工具调用：{"name": "session_status", "arguments": {}}
11:29:16.822 - Agent 结束
11:29:16.824 - Prompt 结束（耗时 1969ms）
11:29:16.830 - Agent 运行完成（总耗时 2004ms）
11:29:17.376 - 分发完成（queuedFinal=false, replies=0）
```

## 关键发现

### 1. Agent 返回了工具调用而不是文本回复
```json
{
  "name": "session_status",
  "arguments": {}
}
```

这是一个**工具调用（tool call）**，不是正常的文本回复。

### 2. 分发状态异常
```
queuedFinal=false, replies=0
```

- `queuedFinal=false`：表示这不是最终回复
- `replies=0`：没有文本回复被发送

### 3. 执行流程对比

| 项目 | 第一次调用 | 第二次调用 |
|------|-----------|-----------|
| Agent 耗时 | 426ms | 2004ms |
| 返回内容 | 错误文本 | 工具调用 |
| 发送回复 | 是（1条） | 否（0条） |
| queuedFinal | true | false |

## 问题分析

### 为什么返回工具调用？

可能的原因：

1. **模型误判**：通义千问模型认为用户的消息需要调用 `session_status` 工具
2. **系统提示词问题**：Agent 的系统提示词可能包含了工具定义，导致模型倾向于调用工具
3. **上下文混乱**：之前的错误可能影响了 Agent 的状态

### 为什么没有发送回复？

从日志看：
```
feishu deliver called: text={"name": "session_status", "arguments": {}}
feishu deliver: sending 1 text chunks to oc_acffe3c669016db989b35175a7889b4a
```

**实际上发送了**，但发送的是工具调用的 JSON，而不是用户友好的文本。

## 根本原因

### 主要问题：阿里云账户欠费
第一次调用失败是因为账户欠费，这是明确的。

### 次要问题：工具调用处理异常
第二次调用中，Agent 返回了工具调用而不是文本，可能是因为：

1. **模型行为异常**：在账户欠费的情况下，API 可能返回了异常响应
2. **错误处理不当**：Clawdbot 没有正确处理 API 错误，导致 Agent 状态异常
3. **工具定义泄露**：系统提示词中的工具定义被模型"看到"并误用

## 验证方法

查看第二次调用时用户发送的消息内容：

```bash
# 查找用户消息内容
grep -A 5 "11:29:14" /tmp/clawdbot/clawdbot-*.log | grep -i "message\|content"
```

## 解决方案

### 立即解决：充值阿里云账户
1. 登录阿里云控制台
2. 充值账户
3. 重试飞书消息

### 长期解决：改进错误处理
1. 当 API 返回 400 错误时，应该返回友好的错误消息
2. 不应该让工具调用的 JSON 直接发送给用户
3. 添加账户余额监控和预警

## 测试建议

充值后，在飞书发送简单消息测试：
```
你好
```

预期结果：
- Agent 耗时：1-3 秒
- 返回内容：正常的文本回复
- queuedFinal：true
- replies：1

## 总结

**第一次调用**：明确失败，原因是阿里云账户欠费
**第二次调用**：Agent 返回了工具调用而不是文本，可能是因为：
- API 错误导致的异常状态
- 或者用户消息触发了工具调用逻辑

**核心问题**：阿里云账户欠费，充值后问题应该解决
